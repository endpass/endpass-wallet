<template>
  <v-modal
    class="is-dark"
    @close="handleClose"
  >
    <template slot="header">Get Started</template>

    <p
      v-if="isSelectDefaultIdentity"
      class="subtitle"
    >Please enter your email address below to access your wallet or create a new one.</p>
    <p
      v-else-if="isSelectCustomIdentity"
      class="subtitle"
    >Please enter your server address below to access your accounts.</p>

    <v-form
      id="loginByEmail"
      @submit="handleSubmit"
      :isFormValid="isFormValid"
    >
      <v-input
        v-if="isSelectDefaultIdentity"
        key="email-input"
        v-model="email"
        :disabled="!isInputAllowed"
        autofocus
        label="Email"
        help="Your email address may be used to help recover your wallet in case you lose access."
        name="email"
        data-vv-name="email"
        v-validate="'required|email'"
        :error="errors.first('email')"
        placeholder="Your email"
      />

      <v-select
        :disabled="!isInputAllowed"
        :options="availableIdentityServerTypes"
        v-model="currentIdentityServerType"
        label="Identity Server"
        name="currentIdentityServerType"
      />

      <v-input
        v-if="isSelectCustomIdentity"
        id="customIdentityServer"
        key="custom-identity-server"
        v-model="customIdentityServer"
        :disabled="!isInputAllowed"
        label="Custom Identity Server"
        data-vv-name="customIdentityServer"
        name="customIdentityServer"
        v-validate="'required|url:require_protocol:true'"
        :error="errors.first('customIdentityServer')"
        placeholder="Custom Identity Server"
        help="Example: https://yourserver.com/api"
      />

      <v-checkbox
        v-if="isSelectDefaultIdentity"
        v-model="termsAccepted"
      >
        I accept the
        <a
          href="https://endpass.com/terms/"
          target="_blank"
        >Terms of Service</a>
        and
        <a
          href="https://endpass.com/privacy/"
          target="_blank"
        >Privacy Policy</a>.
      </v-checkbox>
    </v-form>
    <div
      slot="footer"
      class="buttons"
    >
      <v-button
        :disabled="!termsAccepted || !isFormValid"
        :loading="!isInputAllowed"
        class-name="is-primary is-medium"
        form="loginByEmail"
        data-test="submit-login"
      >Continue</v-button>
    </div>
  </v-modal>
</template>

<script>
import { IDENTITY_MODE } from '@/constants';
import { mapActions } from 'vuex';
import error from '@/mixins/error';
import formMixin from '@/mixins/form';

const availableIdentityServerTypes = [
  { text: 'Endpass', val: IDENTITY_MODE.DEFAULT },
  { text: 'Local Storage', val: IDENTITY_MODE.LOCAL },
  { text: 'Custom server', val: IDENTITY_MODE.CUSTOM },
].filter(mode => !(ENV.isProduction && mode.val === IDENTITY_MODE.LOCAL));

export default {
  name: 'LoginByEmailModal',
  props: {
    isLoading: {
      type: Boolean,
      default: false,
    },
  },
  data: () => ({
    email: '',
    termsAccepted: true,
    availableIdentityServerTypes,
    currentIdentityServerType: availableIdentityServerTypes[0].val,
    customIdentityServer: null,
    isValidating: false,
  }),
  computed: {
    isInputAllowed() {
      return !this.isLoading && !this.isValidating;
    },
    isSelectDefaultIdentity() {
      return this.currentIdentityServerType === IDENTITY_MODE.DEFAULT;
    },
    isSelectCustomIdentity() {
      return this.currentIdentityServerType === IDENTITY_MODE.CUSTOM;
    },
  },
  methods: {
    ...mapActions('user', ['validateCustomServer']),
    async validateServer(serverUrl) {
      this.isValidating = true;

      try {
        await this.validateCustomServer({ serverUrl });
      } finally {
        this.isValidating = false;
      }
    },
    async handleSubmit() {
      try {
        this.$ga.event({
          eventCategory: 'onboarding',
          eventAction: 'submit_email',
        });

        let serverUrl;

        if (this.isSelectCustomIdentity) {
          serverUrl = this.customIdentityServer.replace(/\/+$/, '');
          await this.validateServer(serverUrl);
        }

        const mode = {
          type: this.currentIdentityServerType,
          serverUrl,
        };

        this.$emit('confirm', { email: this.email, mode });
      } catch (e) {
        this.emitError(e);
      }
    },
    handleClose() {
      this.$emit('close');
    },
  },
  mixins: [error, formMixin],
};
</script>
